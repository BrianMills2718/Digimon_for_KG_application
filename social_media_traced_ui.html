<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIMON Social Media Analysis with Execution Tracing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .trace-step {
            transition: all 0.3s ease;
        }
        
        .trace-step:hover {
            background-color: #f3f4f6;
        }
        
        .progress-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div x-data="tracedAnalysis()" x-init="init()" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">DIGIMON Social Media Analysis with Execution Tracing</h1>
            <p class="text-gray-600">Real-time execution tracking and detailed analysis of COVID-19 conspiracy theories</p>
        </div>

        <!-- Main Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Panel: Configuration -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Dataset Ingestion -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">1. Dataset</h2>
                    
                    <div class="space-y-4">
                        <button 
                            @click="ingestDataset()"
                            :disabled="loading.dataset"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        >
                            <span x-show="!loading.dataset">Load COVID Dataset</span>
                            <span x-show="loading.dataset" class="flex items-center justify-center">
                                <div class="loading-spinner w-5 h-5 mr-2"></div>
                                Loading...
                            </span>
                        </button>
                        
                        <div x-show="datasetInfo" class="p-3 bg-green-50 rounded-md text-sm">
                            <div class="font-semibold text-green-800">Dataset Ready!</div>
                            <div class="text-green-700">
                                <span x-text="datasetInfo?.total_rows"></span> tweets loaded
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Configuration -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">2. Configure</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Scenarios</label>
                            <input 
                                type="number" 
                                x-model="planConfig.numScenarios"
                                min="1" max="10"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        
                        <button 
                            @click="generateAnalysisPlan()"
                            :disabled="loading.plan || !datasetInfo"
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        >
                            Generate Plan
                        </button>
                    </div>
                </div>

                <!-- Execute Analysis -->
                <div x-show="analysisPlan?.scenarios?.length > 0" class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">3. Execute</h2>
                    
                    <button 
                        @click="executeAnalysis()"
                        :disabled="loading.execution || currentJob"
                        class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                    >
                        <span x-show="!currentJob">Execute Analysis</span>
                        <span x-show="currentJob" class="flex items-center justify-center">
                            <div class="loading-spinner w-5 h-5 mr-2"></div>
                            Running...
                        </span>
                    </button>
                </div>
            </div>

            <!-- Center Panel: Execution Trace -->
            <div class="lg:col-span-2">
                <!-- Execution Progress -->
                <div x-show="executionTrace" class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Execution Progress</h2>
                        <span class="text-sm text-gray-500" x-text="`Job: ${currentJob || 'None'}`"></span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                class="bg-purple-600 h-3 rounded-full transition-all duration-500"
                                :style="`width: ${executionTrace?.progress || 0}%`"
                            ></div>
                        </div>
                        <div class="flex justify-between mt-2 text-sm text-gray-600">
                            <span x-text="`${executionTrace?.progress || 0}% Complete`"></span>
                            <span x-text="executionTrace?.status || 'Not started'"></span>
                        </div>
                    </div>
                    
                    <!-- Current Step -->
                    <div x-show="currentStep" class="p-3 bg-blue-50 rounded-md mb-4">
                        <div class="font-semibold text-blue-800">Current Step:</div>
                        <div class="text-blue-700" x-text="currentStep"></div>
                    </div>
                </div>

                <!-- Execution Plan -->
                <div x-show="executionTrace?.execution_plan" class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Execution Plan</h3>
                    <div class="space-y-2">
                        <template x-for="(step, index) in executionTrace?.execution_plan?.steps || []" :key="index">
                            <div class="flex items-center space-x-3 p-2 rounded"
                                 :class="{'bg-green-50': completedSteps.includes(step.id), 'bg-blue-50': currentStepId === step.id}">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold"
                                     :class="{
                                         'bg-green-500 text-white': completedSteps.includes(step.id),
                                         'bg-blue-500 text-white': currentStepId === step.id,
                                         'bg-gray-300 text-gray-600': !completedSteps.includes(step.id) && currentStepId !== step.id
                                     }">
                                    <span x-text="index + 1"></span>
                                </div>
                                <div class="flex-grow">
                                    <div class="font-medium" x-text="step.description"></div>
                                    <div class="text-sm text-gray-600" x-text="step.id"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Recent Trace Events -->
                <div x-show="executionTrace?.recent_steps?.length > 0" class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Recent Activity</h3>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        <template x-for="(event, index) in executionTrace?.recent_steps || []" :key="index">
                            <div class="trace-step p-2 rounded border border-gray-200">
                                <div class="flex justify-between items-start">
                                    <div class="flex-grow">
                                        <span class="font-medium text-sm" x-text="event.type"></span>
                                        <div class="text-xs text-gray-600 mt-1" x-text="formatEventData(event.data)"></div>
                                    </div>
                                    <span class="text-xs text-gray-500" x-text="formatTimestamp(event.timestamp)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Scenarios Overview -->
                <div x-show="analysisPlan?.scenarios?.length > 0" class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Analysis Scenarios</h3>
                    <div class="space-y-2">
                        <template x-for="(scenario, index) in analysisPlan?.scenarios || []" :key="index">
                            <div class="p-3 rounded border cursor-pointer hover:border-blue-300 transition-colors"
                                 :class="{'border-blue-500 bg-blue-50': selectedScenario?.title === scenario.title}"
                                 @click="selectedScenario = scenario">
                                <div class="font-medium text-sm" x-text="scenario.title"></div>
                                <div class="text-xs text-gray-600 mt-1">
                                    <span class="px-2 py-0.5 rounded-full"
                                          :class="{
                                              'bg-green-100 text-green-700': scenario.complexity_level === 'Simple',
                                              'bg-yellow-100 text-yellow-700': scenario.complexity_level === 'Medium',
                                              'bg-red-100 text-red-700': scenario.complexity_level === 'Complex'
                                          }"
                                          x-text="scenario.complexity_level"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Analysis Results Summary -->
                <div x-show="executionTrace?.results" class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Scenarios Analyzed</span>
                            <span class="font-semibold" x-text="executionTrace?.results?.scenario_results?.length || 0"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Insights</span>
                            <span class="font-semibold" x-text="executionTrace?.results?.execution_summary?.total_insights_generated || 0"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Entities Found</span>
                            <span class="font-semibold" x-text="executionTrace?.results?.execution_summary?.total_entities_found || 0"></span>
                        </div>
                        <button 
                            @click="showDetailedResults = true"
                            class="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
                        >
                            View Detailed Results
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Results Modal -->
        <div 
            x-show="showDetailedResults && executionTrace?.results" 
            x-transition
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
            @click.away="showDetailedResults = false"
        >
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6" @click.stop>
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-2xl font-semibold">Detailed Analysis Results</h3>
                    <button 
                        @click="showDetailedResults = false"
                        class="text-gray-400 hover:text-gray-600"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-6" x-show="executionTrace?.results?.scenario_results">
                    <template x-for="(result, index) in executionTrace?.results?.scenario_results || []" :key="index">
                        <div class="border rounded-lg p-4">
                            <h4 class="text-lg font-semibold mb-2" x-text="result.scenario"></h4>
                            <p class="text-gray-600 mb-4" x-text="result.research_question"></p>
                            
                            <!-- Insights -->
                            <div class="space-y-4" x-show="result.insights && result.insights.length > 0">
                                <template x-for="insight in result.insights" :key="insight.interrogative">
                                    <div class="bg-gray-50 rounded p-3">
                                        <h5 class="font-semibold text-blue-700 mb-2">
                                            <span x-text="insight.interrogative"></span>: <span x-text="insight.focus"></span>
                                        </h5>
                                        
                                        <div x-show="insight.findings && insight.findings.length > 0">
                                            <ul class="space-y-1">
                                                <template x-for="finding in insight.findings" :key="finding.entity">
                                                    <li class="text-sm">
                                                        <strong x-text="finding.entity"></strong>
                                                        <span class="text-gray-600" x-show="finding.score > 0">
                                                            (score: <span x-text="finding.score.toFixed(2)"></span>)
                                                        </span>
                                                        <span x-show="finding.description" class="text-gray-600">
                                                            - <span x-text="finding.description"></span>
                                                        </span>
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Error display -->
                            <div x-show="result.error" class="bg-red-50 rounded p-3 mt-4">
                                <p class="text-red-700">Error: <span x-text="result.error"></span></p>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button 
                        @click="downloadTrace()"
                        class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700"
                    >
                        Download Full Trace
                    </button>
                    <button 
                        @click="showDetailedResults = false"
                        class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function tracedAnalysis() {
            return {
                // State
                apiBase: 'http://localhost:5000',
                datasetInfo: null,
                planConfig: {
                    numScenarios: 3,
                    complexityRange: ['Simple', 'Medium']
                },
                loading: {
                    dataset: false,
                    plan: false,
                    execution: false
                },
                analysisPlan: null,
                selectedScenario: null,
                currentJob: null,
                executionTrace: null,
                currentStep: null,
                currentStepId: null,
                completedSteps: [],
                showDetailedResults: false,
                pollInterval: null,
                
                // Initialize
                init() {
                    this.checkExistingJobs();
                },
                
                // Methods
                async ingestDataset() {
                    this.loading.dataset = true;
                    try {
                        const response = await fetch(`${this.apiBase}/api/ingest-dataset`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                dataset_name: 'COVID-19-conspiracy-theories-tweets.csv',
                                source_type: 'local'
                            })
                        });
                        
                        if (!response.ok) throw new Error('Failed to ingest dataset');
                        
                        const data = await response.json();
                        this.datasetInfo = data;
                    } catch (error) {
                        console.error('Dataset ingestion error:', error);
                        // Demo fallback
                        this.datasetInfo = {
                            total_rows: 6591,
                            conspiracy_types: ['CT_1', 'CT_2', 'CT_3', 'CT_4', 'CT_5', 'CT_6']
                        };
                    } finally {
                        this.loading.dataset = false;
                    }
                },
                
                async generateAnalysisPlan() {
                    this.loading.plan = true;
                    try {
                        const response = await fetch(`${this.apiBase}/api/generate-plan`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                domain: 'COVID-19 conspiracy theories on Twitter',
                                dataset_info: this.datasetInfo,
                                num_scenarios: this.planConfig.numScenarios,
                                complexity_range: this.planConfig.complexityRange
                            })
                        });
                        
                        if (!response.ok) throw new Error('Failed to generate plan');
                        
                        const data = await response.json();
                        this.analysisPlan = data;
                    } catch (error) {
                        console.error('Plan generation error:', error);
                        alert('Error generating plan: ' + error.message);
                    } finally {
                        this.loading.plan = false;
                    }
                },
                
                async executeAnalysis() {
                    this.loading.execution = true;
                    try {
                        const response = await fetch(`${this.apiBase}/api/execute-analysis`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                scenarios: this.analysisPlan.scenarios,
                                dataset_path: 'COVID-19-conspiracy-theories-tweets.csv'
                            })
                        });
                        
                        if (!response.ok) throw new Error('Failed to start analysis');
                        
                        const data = await response.json();
                        
                        if (data.success && data.job_id) {
                            this.currentJob = data.job_id;
                            this.startTracePolling(data.job_id);
                        } else {
                            alert('Failed to start analysis: ' + (data.error || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Execution error:', error);
                        alert('Error starting analysis: ' + error.message);
                    } finally {
                        this.loading.execution = false;
                    }
                },
                
                async startTracePolling(jobId) {
                    // Clear any existing polling
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                    }
                    
                    // Poll every 2 seconds
                    this.pollInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`${this.apiBase}/api/execution-trace/${jobId}`);
                            const data = await response.json();
                            
                            this.executionTrace = data;
                            
                            // Update current step
                            if (data.recent_steps && data.recent_steps.length > 0) {
                                const lastStep = data.recent_steps[data.recent_steps.length - 1];
                                if (lastStep.type === 'progress') {
                                    this.currentStep = lastStep.data.message;
                                } else if (lastStep.type === 'tool_execution_start') {
                                    this.currentStep = `Executing: ${lastStep.data.tool}`;
                                    this.currentStepId = lastStep.data.tool;
                                } else if (lastStep.type === 'tool_execution_complete') {
                                    this.completedSteps.push(lastStep.data.tool);
                                }
                            }
                            
                            // Stop polling if completed or failed
                            if (data.status === 'completed' || data.status === 'failed') {
                                clearInterval(this.pollInterval);
                                this.currentJob = null;
                                
                                if (data.status === 'completed') {
                                    this.showDetailedResults = true;
                                } else if (data.error) {
                                    alert('Analysis failed: ' + data.error);
                                }
                            }
                        } catch (error) {
                            console.error('Trace polling error:', error);
                        }
                    }, 2000);
                },
                
                async checkExistingJobs() {
                    try {
                        const response = await fetch(`${this.apiBase}/api/analysis-status`);
                        const data = await response.json();
                        
                        // Check for any in-progress jobs
                        const inProgress = data.jobs?.find(job => job.status === 'in_progress');
                        if (inProgress) {
                            this.currentJob = inProgress.job_id;
                            this.startTracePolling(inProgress.job_id);
                        }
                    } catch (error) {
                        console.error('Failed to check existing jobs:', error);
                    }
                },
                
                formatEventData(data) {
                    if (typeof data === 'string') return data;
                    if (data.message) return data.message;
                    if (data.tool) return `Tool: ${data.tool}`;
                    if (data.step) return `Step: ${data.step}`;
                    if (data.error) return `Error: ${data.error}`;
                    return JSON.stringify(data, null, 2).substring(0, 100) + '...';
                },
                
                formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString();
                },
                
                async downloadTrace() {
                    if (!this.executionTrace) return;
                    
                    try {
                        const response = await fetch(`${this.apiBase}/api/execution-trace/${this.currentJob || 'latest'}/full`);
                        const fullTrace = await response.json();
                        
                        const dataStr = JSON.stringify(fullTrace, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        
                        const exportFileDefaultName = `execution_trace_${new Date().toISOString().slice(0,19).replace(/[:\-]/g, '')}.json`;
                        
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.click();
                    } catch (error) {
                        console.error('Download error:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>